# PicLoader2022
Java(Swing)で動作する柳沢PIC形式の画像ローダーです。
PIC形式の画像を表示させることができます。
稲妻走ります。

## 柳沢PIC形式について
柳沢PIC形式はX68000で使われた画像圧縮形式です。
以下の記事が参考になると思います。
- Wikipedia の [PIC](https://ja.wikipedia.org/wiki/PIC_(%E7%94%BB%E5%83%8F%E5%9C%A7%E7%B8%AE))
- Qiita [Unityで柳沢PIC形式の画像を読込む](https://qiita.com/tomotaco/items/705f79ae59368417aef8)

原作者である、やなぎさわ氏( http://www.vector.co.jp/vpack/browse/person/an001322.html )により、PICフォーマット仕様書が Vector で公開されています( http://www.vector.co.jp/soft/data/art/se003198.html )。

本プログラムでの画像読み込み処理は、これに同梱された「PICの説明のオマケのローダー」と位置づけされる picl.c に基づきます。

## 使用方法
### 起動と画像の表示
jarディレクトリの中の picloader2022.jar を使います。
以下のコマンドラインでプログラムを起動します(または、 関連付けしてあれば jar のダブルクリックでも起動すると思います)。
```
java -jar picloader2022.jar
```

ウィンドウが開くので PIC画像形式のファイルをドラッグドロップします。
画像の読み込みが行われると思います。

![起動直後の画面](./readme_fig/fig1.png)

### マウス操作
ウィンドウ内部の表示域を左クリックすると、画面サイズが変更します。
| 拡大モード  | 拡大方法                             |
--------------|--------------------------------------
| 1           | 512 × 512 等倍                      |
| 2           | 512 × 512 を 2 × 2 ドットで拡大    |
| 3           | 512 × 512 を 3 × 2 ドットで拡大    |

### その他の操作
起動してから終了するまでの間、読み込んだファイル名の履歴を覚えています。
再表示をさかのぼることや、複数の画像を順番に見ることができます。

| 入力キー    | 操作                                                                    |
--------------|-------------------------------------------------------------------------
| S           | 画面の拡大モードを 1 → 2 → 3 の順に切り替えます。                     |
| SHIFT + S   | 画面の拡大モードを 3 → 2 → 1 の順に切り替えます。                     |
| ←          | 一つ前に読み込んだ画像を表示します。繰り返すと履歴をさかのぼります。    |
| SHIFT + ←  | 最初に読み込んだ画像を表示します。                                      |
| →          | 「一つ後の画像」を表示します。                                          |
| SHIFT + →  | 最後に読み込んだ画像を表示します。                                      |
| R           | 画像を再度読み込みます                                                  |
| C           | いま表示している画像を履歴からクリアします                              |
| D           | 画像の読み込みの履歴をすべてクリアします                                |
| N           | 画像の読み込みをノーウェイトで行うよう切り換えます(トグル動作)。        |
| スペース    | 表示中の読み込み処理があればウェイト処理を打ち切ります。 表示済の場合次の画像を表示します。 |
| Q           | 終了します。                                                            |

## このプログラムについて
### PICの読み込み処理
原作者、やなぎさわ氏( http://www.vector.co.jp/vpack/browse/person/an001322.html )によるPICフォーマット仕様書( http://www.vector.co.jp/soft/data/art/se003198.html )に同梱された「PICの説明のオマケのローダー」と位置づけされる picl.c に基づきます。

基本的にはCで書かれたものをほぼそのままJavaにベタで書き写しています。
以下の作り込みとかはしてます。
- picl.cはX68000のGVRAMにアクセスする作りになっているので、それを代替するようなバッファを作成
- ロード時、稲妻に形容される模様が画面上に表れるよう、あえてゆっくり読み込むように作り込み

### ウィンドウアプリケーションとしての動作
Swingで適当に作っていて、読み込み済ファイルの履歴を持っていて再表示するとかの作り込みだけしています。
複数のファイルをドラッグドロップしたときに、ファイル数だけローダーのオブジェクトを作成し、資源を野放図に使ってしまう作りが気になるのですが、いったんこのまま放置します。

### その他
jarの再作成は、Windows環境であれば以下のコマンドラインで行います。

```
jar cfm ..\picloader2022.jar ..\META-INF\manifest.mf com\github\novisoftware\pic2022\picLoader\*.class com\github\novisoftware\pic2022\viewer\*.class com\github\novisoftware\pic2022\viewer\*.png
```

# PICデータフォーマット
PICデータフォーマットをやなぎさわさんの解説記事から抜粋転記します。

(図はテキストファイル中のAAを元に書き起こしました)


全体は以下で構成されます。
- ヘッダ
- 圧縮データ

## ヘッダ

|    データ    |   データ長      |       意味                |
---------------|-----------------|----------------------------
|       'P'    |   1byte         |  ＰＩＣであることの印     |
|       'I'    |   1byte         |                           |
|       'C'    |   1byte         |                           |
|       $1A以外  | 任意byte      |  コメント部               |
|       $1A(EOF) | 1byte         | コメントの終わりを示す    |
|       0以外    | 任意byte      | ダミー                    |
|       0        | 1byte         | 真のコメントの終わり      |
|       0        | 1byte         |    予約                   |
|       x       | 1byte          |    bit 0..3 機種タイプ                               |
|               |                |   bit 4..7 機種毎のモード                            |
|       x       | 1word (2byte)   |   色のビット数                                     |
|       x       | 1word             |  Ｘ方向のサイズ                                  |
|       x       | 1word             | Ｙ方向のサイズ                                   |
|       p       | nbyte              |  パレットデータなど                             |
|               |                   | 内容は機種／モード／色数によって変わります       |
|               |                   | (オリジナルは、ここは何もない)                   |

## 圧縮データ
圧縮データは以下のように繰り返します。
![圧縮データの構造](./readme_fig/layout.png)

### 長さ
長さは以下に例示されるように符号化されます。

 | 表現する範囲 | 符号         |
----------------|---------------
 | 1～2 | 0X                   |
 | 3～6 | 10XX                 |
 | 7～14 | 110XXX              |
 | 15～30 | 1110XXXX           |
 | 31～62 | 11110XXXXX         |
 | 63～126 | 111110XXXXXX      |
 | 127～254 | 1111110XXXXXXX   |
 | 255～510 | 11111110XXXXXXXX |
 |    :     |        :         |

### 色

![圧縮データの構造](./readme_fig/color.png)

以下は pic_fmt.txt から抜粋です(抜粋後、一部の文言をリンク化)。
> 同じ色は近所にあることが多いと言うことを利用して簡単なキャッシュをします。
> 具体的には過去128色分をテーブルに取って置き、次の色が来たときに既にその色がテーブル中にあれば、テーブル中に有るというフラグ＋テーブル中の位置を記録するようにして、テーブル中に無ければ、無いというフラグ＋色コードを記録するようにします。
> これで同じ色が頻繁に出てくる場合は、少ないビット数で済みます。

> またテーブルに無い色が出たときには、テーブルから最も古くに使用された色コードを捨てて代わりにこの新しい色をセットすることを行います。[LRU法](https://ja.wikipedia.org/wiki/Least_Recently_Used)ですね。

### 連鎖

![圧縮データの構造](./readme_fig/chain.png)

